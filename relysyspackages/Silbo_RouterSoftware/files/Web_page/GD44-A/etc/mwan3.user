#!/bin/sh
#
# This file is interpreted as shell script.
# Put your custom mwan3 action here, they will
# be executed with each netifd hotplug interface event
# on interfaces for which mwan3 is enabled.
#
# There are three main environment variables that are passed to this script.
#
# $ACTION
#      <ifup>         Is called by netifd and mwan3track
#      <ifdown>       Is called by netifd and mwan3track
#      <connected>    Is only called by mwan3track if tracking was successful
#      <disconnected> Is only called by mwan3track if tracking has failed
# $INTERFACE	Name of the interface which went up or down (e.g. "wan" or "wwan")
# $DEVICE	Physical device name which interface went up or down (e.g. "eth0" or "wwan0")

. /lib/functions.sh

SystemConfigFile="/etc/config/sysconfig"
touch /tmp/networkstatus
chmod 0777 /tmp/networkstatus
ReadSystemConfigFile()
{
   	config_load "$SystemConfigFile"
   	config_get PrimarySimSwitchBackEnable sysconfig primarysimswitchbackenable
   	config_get PrimarySimSwitchBackTime sysconfig primarysimswitchbacktime
	config_get EnableCellular sysconfig enablecellular
	config_get Port4Mode sysconfig port4mode
	config_get EthernetProtocolPort4wan1 sysconfig EthernetProtocolPort4wan
	config_get EthernetClientDHCPGatewayPort4wan1 sysconfig EthernetClientDHCPGatewayPort4wan
	config_get EthernetClientStaticGatewayPort4wan1 sysconfig EthernetClientStaticGatewayPort4wan
	config_get Port5Mode sysconfig port5mode
	config_get portmode sysconfig portmode
	config_get EthernetClientDHCPGatewayPort5wan2 sysconfig EthernetClientDHCPGatewayPort5wan
	config_get EthernetClientStaticGatewayPort5wan2 sysconfig EthernetClientStaticGatewayPort5wan
	config_get EthernetProtocolPort5wan2 sysconfig EthernetProtocolPort5wan
	config_get Wifi1Mode sysconfig wifi1mode
	config_get CellularOperationModelocal sysconfig CellularOperationMode
    config_get PortType1 sysconfig porttype1
	config_get ComPort1 sysconfig comport1
	config_get SmsEnable1 sysconfig smsenable1
	config_get SmsEnable2 sysconfig smsenable2
	config_get EthernetClientPptpServerAddress sysconfig EthernetClientPptpServerAddress
	config_get EthernetProtocolPort5wan2 sysconfig EthernetProtocolPort5wan
	config_get EthernetProtocolPortwan sysconfig EthernetProtocolPortwan
	config_get EthernetClientStaticGatewayPortwan sysconfig EthernetClientStaticGatewayPortwan
	config_get EthernetClientDHCPGatewayPortwan sysconfig EthernetClientDHCPGatewayPortwan
}

ReadSystemGpioFile()                               
{                                                    
        config_load "$SystemGpioConfig"              
        config_get BoardPowerGpio gpio boardpowergpio
        config_get BoardOnValue gpio boardonvalue
        config_get BoardOffValue gpio boardoffvalue
        config_get NoOfModem gpio noofmodem
        config_get Modem1PowerGpio gpio modem1powergpio
        config_get Modem1PowerOnValue gpio modem1poweronvalue
        config_get Modem1PowerOffValue gpio modem1poweroffvalue
        config_get Modem2PowerGpio gpio modem2powergpio
        config_get Modem2PowerOnValue gpio modem2poweronvalue
        config_get Modem2PowerOffValue gpio modem2poweroffvalue
        config_get ExternelUsb gpio externelusb
        config_get ExternelUsbGpio gpio externelusbgpio
        config_get ExternelUsbOnValue gpio externelusbonvalue
        config_get ExternelUsbOffValue gpio externelusboffvalue
        config_get SimSelectGpio gpio simselectgpio
        config_get Sim1SelectValue gpio sim1selectvalue
        config_get Sim2SelectValue gpio sim2selectvalue
        config_get NoOfProgramLed gpio noofprogramled
        config_get ProgramLed1Number gpio programled1number
        config_get ProgramLed1OnValue gpio programled1onvalue
        config_get ProgramLed1OffValue gpio programled1offvalue
        config_get ProgramLed2Number gpio programled2number
        config_get ProgramLed2OnValue gpio programled2onvalue
        config_get ProgramLed2OffValue gpio programled2offvalue
        config_get ProgramLed3Number gpio programled3number
        config_get ProgramLed3OnValue gpio programled3onvalue
        config_get ProgramLed3OffValue gpio programled3offvalue
        config_get SystemResetSwitch gpio systemresetswitch
}

SystemGpioConfig="/etc/config/systemgpio"
ReadSystemGpioFile
ReadSystemConfigFile
Sim1DataFlagFile="/etc/sim1dataflag"
Sim2DataFlagFile="/etc/sim2dataflag"

#NMS_Enable=$(uci get nmsconfig.nmsconfig.nmsenable)
NMS_Enable=$(uci get remoteconfig.nms.nmsenable)

IpsecEnable=$(uci get vpnconfig1.general.enableipsecgeneral)
OpenvpnEnable=$(uci get vpnconfig1.general.enableopenvpngeneral)
if [ "$portmode" = "EWAN" ]
then
 ewanmetric=$(uci get mwan3config.EWAN.wanpriority)
fi
if [ "$Port5Mode" = "EWAN2" ]
then
 ewan2metric=$(uci get mwan3config.EWAN2.wanpriority)
fi
if [ "$Port4Mode" = "EWAN1" ]                                       
then 
 ewan1metric=$(uci get mwan3config.EWAN1.wanpriority)
fi
if [ "$Wifi1Mode" = "apsta" ] || [ "$Wifi1Mode" = "sta" ]
then
  wifimetric=$(uci get mwan3config.WIFI_WAN.wanpriority)
fi
if [ "$EnableCellular" = "1" ]
then
   if [ "$CellularOperationModelocal" = "singlecellulardualsim" ]
   then
     cwan1metric=$(uci get mwan3config.CWAN1_0.wanpriority)
     cwan2metric=$(uci get mwan3config.CWAN1_1.wanpriority)
   fi
   if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                    
   then
     cwan1metric=$(uci get mwan3config.CWAN1.wanpriority)
   fi
fi

[ ! -d /tmp/InterfaceStatus ] && mkdir -p /tmp/InterfaceStatus

if [ "${ACTION}" = "ifdown" ] && [ "${INTERFACE}" = "EWAN" ] ; then                         
   # Do something on an ifup event for the wan interface only
  if [ "$EthernetProtocolPortwan" = "static" ]
  then
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric 0 > /dev/null 2>&1
   /bin/sleep 1
   /sbin/route add -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
  else
    ifconfig eth0.2 down
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric 0 > /dev/null 2>&1 
   /bin/sleep 1                                                     
   /sbin/route add -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
  fi
   [ ! -f /tmp/InterfaceStatus/EWAN1Status ] && touch /tmp/InterfaceStatus/EWAN1Status                                             
   echo "`date` Interface EWAN DOWN" >> /tmp/InterfaceStatus/EWAN1Status 
   echo "0" > /tmp/networkstatus   
  if [ "$IpsecEnable" = "1" ] ; then
     interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN"                                                                                     
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                   
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                                
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi    
   if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
   fi    
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi  
   killall pppd                                                       
fi   

if [ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "EWAN" ] ; then          
   # Do something on an ifup event for the wan interface only
  if [ "$EthernetProtocolPortwan" = "static" ]
  then
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric 0 > /dev/null 2>&1
   /bin/sleep 1
   /sbin/route add -net default gw "${EthernetClientStaticGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
  else
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric 0 > /dev/null 2>&1 
   /bin/sleep 1                                                     
   /sbin/route add -net default gw "${EthernetClientDHCPGatewayPortwan}" dev eth0 metric "${ewanmetric}" > /dev/null 2>&1
  fi
   [ ! -f /tmp/InterfaceStatus/EWAN1Status ] && touch /tmp/InterfaceStatus/EWAN1Status                                             
   echo "`date` Interface EWAN UP" >> /tmp/InterfaceStatus/EWAN1Status 
    echo "1" > /tmp/networkstatus   
   if [ "$IpsecEnable" = "1" ] ; then
     interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN"                                                                                     
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                   
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                                
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi    
   if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
   fi    
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi  
   killall pppd                                                           
fi

if [ "${ACTION}" = "ifdown" ] && [ "${INTERFACE}" = "EWAN1" ] ; then                         
   # Do something on an ifup event for the wan interface only
  if [ "$EthernetProtocolPort4wan1" = "static" ]
  then
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric 0 > /dev/null 2>&1
   /bin/sleep 1
   /sbin/route add -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
  else
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric 0 > /dev/null 2>&1
   /bin/sleep 1                                                     
   /sbin/route add -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
  fi
   [ ! -f /tmp/InterfaceStatus/EWAN1Status ] && touch /tmp/InterfaceStatus/EWAN1Status
   echo "`date` Interface EWAN1 DOWN" >> /tmp/InterfaceStatus/EWAN1Status
   echo "0" > /tmp/networkstatus
   if [ "$IpsecEnable" = "1" ] ; then 
    interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2" 
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                     
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
 
   /etc/init.d/ipsec stop
   /bin/sleep 1
   /etc/init.d/ipsec start
   /bin/sleep 4                                                                    
   /usr/sbin/ipsec restart
   fi
   if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
   fi         
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi  
   killall pppd                                                        
fi   

if [ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "EWAN1" ] ; then          
   # Do something on an ifup event for the wan interface only
  if [ "$EthernetProtocolPort4wan1" = "static" ]
  then
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric 0 > /dev/null 2>&1
   /bin/sleep 1
   /sbin/route add -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
  else
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort4wan1}" dev eth0.4 metric 0 > /dev/null 2>&1 
   /bin/sleep 1                                                     
   /sbin/route add -net default gw "${EthernetClientDHCPGatewayPort4wan1}" dev eth0.4 metric "${ewan1metric}" > /dev/null 2>&1
  fi
   [ ! -f /tmp/InterfaceStatus/EWAN1Status ] && touch /tmp/InterfaceStatus/EWAN1Status                                             
   echo "`date` Interface EWAN1 UP" >> /tmp/InterfaceStatus/EWAN1Status 
   echo "1" > /tmp/networkstatus 
   if [ "$IpsecEnable" = "1" ] ; then
     interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2"
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                   
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                                
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi    
   if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
   fi    
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi  
   killall pppd                                                           
fi

if [ "${ACTION}" = "ifdown" ] && [ "${INTERFACE}" = "EWAN2" ] ; then
   # Do something on an ifup event for the wan interface only
  if [ "$EthernetProtocolPort5wan2" = "static" ]
  then
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric 0 > /dev/null 2>&1
   /bin/sleep 1
	/sbin/route add -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   if [ "$EthernetProtocolPort5wan2" = "pptp" ]
   then
      /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
	 ip route add "${EthernetClientPptpServerAddress}" via "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 proto static metric "${ewan2metric}0"  > /dev/null 2>&1
   elif  [ "$EthernetProtocolPort5wan2" = "l2tp" ]
   then
    /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
	ip route add "${EthernetClientPptpServerAddress}" via "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 proto static metric "${ewan2metric}0"  > /dev/null 2>&1
   fi
  else
   ifconfig eth0.5 down
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric 0 > /dev/null 2>&1
   /bin/sleep 1                                             
   /sbin/route add -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   ip route add "${EthernetClientPptpServerAddress}" via "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 proto static metric "${ewan2metric}0"  > /dev/null 2>&1
  fi
   [ ! -f /tmp/InterfaceStatus/EWAN2Status ] && touch /tmp/InterfaceStatus/EWAN2Status                                             
   echo "`date` Interface EWAN2 DOWN" >> /tmp/InterfaceStatus/EWAN2Status
   echo "0" > /tmp/networkstatus   
   if [ "$IpsecEnable" = "1" ] ; then
    interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2"    
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                               
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                                   
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi  
 if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
  fi 
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi   
   killall pppd        
fi

if [ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "EWAN2" ] ; then  
   # Do something on an ifup event for the wan interface only
  if [ "$EthernetProtocolPort5wan2" = "static" ]                                                     
  then                                                                                               
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric 0 > /dev/null 2>&1
   /bin/sleep 1      
   /sbin/route add -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
     if [ "$EthernetProtocolPort5wan2" = "pptp" ]
   then
      #/sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
	 ip route add "${EthernetClientPptpServerAddress}" via "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 proto static metric "${ewan2metric}"  > /dev/null 2>&1
   elif  [ "$EthernetProtocolPort5wan2" = "l2tp" ]
   then
    #/sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
	ip route add "${EthernetClientPptpServerAddress}" via "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 proto static metric "${ewan2metric}"  > /dev/null 2>&1
   fi
  else                                                                                                         
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}0" > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric 0 > /dev/null 2>&1
   /sbin/route del -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric 0 > /dev/null 2>&1
   /bin/sleep 2  
   echo "$EthernetClientDHCPGatewayPort5wan2 gateway updated" > /tmp/ewangw.txt                                                                                               
   /sbin/route add -net default gw "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
   if [ "$EthernetProtocolPort5wan2" = "pptp" ]
   then
      echo "$EthernetClientPptpServerAddress gateway updated" > /tmp/ewangw1.txt                                                                                               

      #/sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
	 ip route add "${EthernetClientPptpServerAddress}" via "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 proto static metric "${ewan2metric}"  > /dev/null 2>&1
   elif  [ "$EthernetProtocolPort5wan2" = "l2tp" ]
   then
   # /sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev eth0.5 metric "${ewan2metric}" > /dev/null 2>&1
	ip route add "${EthernetClientPptpServerAddress}" via "${EthernetClientDHCPGatewayPort5wan2}" dev eth0.5 proto static metric "${ewan2metric}"  > /dev/null 2>&1
   fi
  fi 
   [ ! -f /tmp/InterfaceStatus/EWAN2Status ] && touch /tmp/InterfaceStatus/EWAN2Status                                             
   echo "`date` Interface EWAN2 UP" >> /tmp/InterfaceStatus/EWAN2Status
   echo "1" > /tmp/networkstatus
   if [ "$IpsecEnable" = "1" ] ; then
    interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2"  
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                 
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                                    
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi        
   if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
   fi    
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi   
   #killall pppd                                              
fi        

if ([ "${ACTION}" = "disconnected" ] && [ "${INTERFACE}" = "CWAN1_0" ]) || ([ "${ACTION}" = "disconnected" ] && [ "${INTERFACE}" = "wan6c1" ]) ; then
   # Do something on an ifup event for the wan interface only
   if [ "$EnableCellular" = "1" ]
   then
     BordType=$(uci get boardconfig.board.moduletype)

	if [ "$BordType" = "2" ] || [ "$BordType" = "3" ] || [ "$BordType" = "6" ]
	then
	echo "$ProgramLed1OffValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	fi
   sim=`cat /tmp/simnumfile` 
   if [ "$sim" = "1" ]
   then
      if [ ! -f "$Sim2DataFlagFile" ]
	  then
	    touch "$Sim2DataFlagFile"
	    echo 0 > "$Sim2DataFlagFile"
	  fi
	  Sim2DataFlag=`cat "$Sim2DataFlagFile"`
	if [ "$Sim2DataFlag" = "0" ]
	then
      /root/InterfaceManager/script/SimSwitch.sh CWAN1 2
    else
      /root/InterfaceManager/script/SimSwitch.sh CWAN1 1
    fi
	  if [ ! -f "$Sim1DataFlagFile" ]
	  then
	  touch "$Sim1DataFlagFile"
	  echo 0 > "$Sim1DataFlagFile"
	  fi
	  Sim1DataFlag=`cat "$Sim1DataFlagFile"`
	if [ "$Sim1DataFlag" = "0" ]
	then
     if [ "$PrimarySimSwitchBackEnable" = "1" ]
     then
	    pid=$(pgrep -f "/root/InterfaceManager/script/PrimarySwitch.sh")
		kill -TERM "$pid" > /dev/null 2>&1
		sleep 1
	    kill -KILL "$pid" > /dev/null 2>&1
        /root/InterfaceManager/script/PrimarySwitch.sh "$PrimarySimSwitchBackTime" CWAN1 1 &         
     fi
    else
      	pid=$(pgrep -f "/root/InterfaceManager/script/PrimarySwitch.sh")
		kill -TERM "$pid" > /dev/null 2>&1
		sleep 1
	    kill -KILL "$pid" > /dev/null 2>&1
    fi
   fi
   /usr/sbin/mwan3 ifdown CWAN1_0
   fi
    if [ "$IpsecEnable" = "1" ] ; then
     interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2"
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                   
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                                   
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi 
  if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
   fi
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi      
   killall pppd
   [ ! -f /tmp/InterfaceStatus/CWAN1_0Status ] && touch /tmp/InterfaceStatus/CWAN1_0Status                                  
   echo "`date` Interface CWAN1_0 DOWN" >> /tmp/InterfaceStatus/CWAN1_0Status
   echo "0" > /tmp/networkstatus       
fi

if ([ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "CWAN1_0" ]) || ([ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "wan6c1" ]) ; then            
   # Do something on an ifup event for the wan interface only   
   if [ "$IpsecEnable" = "1" ] ; then    
     interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2" 
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                  
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                                    
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi 
    gtway=$(ifstatus CWAN1_0 | grep -i "nexthop" | cut -d "\"" -f 4) 
   if [ "$EthernetProtocolPort5wan2" = "pptp" ]
   then
      #/sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev usb0 metric "${cwan1metric}" > /dev/null 2>&1
	 ip route add "${EthernetClientPptpServerAddress}" via "${gtway}" dev usb0 proto static metric "${cwan1metric}"  > /dev/null 2>&1
   elif  [ "$EthernetProtocolPort5wan2" = "l2tp" ]
   then
   echo "$EthernetClientPptpServerAddress  and $ gtway gateway "> /tmp/l2tpgw.txt
    #/sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev usb0 metric "${cwan1metric}" > /dev/null 2>&1
	ip route add "${EthernetClientPptpServerAddress}" via "${gtway}" dev usb0 proto static metric "${cwan1metric}"  > /dev/null 2>&1
   fi
  
   
   killall pppd
  if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
   fi
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi      
   [ ! -f /tmp/InterfaceStatus/CWAN1_0Status ] && touch /tmp/InterfaceStatus/CWAN1_0Status                                  
   echo "`date` Interface CWAN1_0 UP" >> /tmp/InterfaceStatus/CWAN1_0Status 
   echo "1" > /tmp/networkstatus  
   
   BordType=$(uci get boardconfig.board.moduletype)

	if [ "$BordType" = "2" ] || [ "$BordType" = "3" ] || [ "$BordType" = "6" ]
	then
	atnetworkinfo1=$(gcom -d /dev/"${PortType1}""${ComPort1}" -s /etc/gcom/atnetworkinfo1.gcom | awk 'NR==2')
	atnetworklatchinfo=$(echo "$atnetworkinfo1" | cut -d ":" -f 2 | cut -d "," -f 4 | tr -d '\011\012\013\014\015\040')

	if [ $atnetworklatchinfo -eq 7 ] || [ $atnetworklatchinfo -eq 8 ]
	then
	echo "$ProgramLed1OnValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	else
	echo "$ProgramLed1OffValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	fi

	fi                                  
fi        

if ([ "${ACTION}" = "disconnected" ] && [ "${INTERFACE}" = "CWAN1_1" ]) || ([ "${ACTION}" = "disconnected" ] && [ "${INTERFACE}" = "wan6c2" ]); then  
   # Do something on an ifup event for the wan interface only
   if [ "$EnableCellular" = "1" ]                                                            
   then
    BordType=$(uci get boardconfig.board.moduletype)

	if [ "$BordType" = "2" ] || [ "$BordType" = "3" ] || [ "$BordType" = "6" ]
	then
	echo "$ProgramLed1OffValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	fi
	
  if [ "$PrimarySimSwitchBackEnable" = "1" ]                                                
  then 
    pid=$(pgrep -f "/root/InterfaceManager/script/PrimarySwitch.sh")
	kill -TERM "$pid" > /dev/null 2>&1
	sleep 1
    kill -KILL "$pid" > /dev/null 2>&1
  fi
   sim=`cat /tmp/simnumfile`                                                
   if [ "$sim" = "2" ]                                              
   then       
      if [ ! -f "$Sim1DataFlagFile" ]
	  then
	  touch "$Sim1DataFlagFile"
	  echo 0 > "$Sim1DataFlagFile"
	  fi
	  Sim1DataFlag=`cat "$Sim1DataFlagFile"`
	if [ "$Sim1DataFlag" = "0" ]
	then                                                      
      /root/InterfaceManager/script/SimSwitch.sh CWAN1 1
     else
      /root/InterfaceManager/script/SimSwitch.sh CWAN1 2 
    fi     
   fi
   /usr/sbin/mwan3 ifdown CWAN1_1
   fi
    if [ "$IpsecEnable" = "1" ] ; then
    interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2"  
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                 
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                               
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi 
  if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
  fi
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi    
   killall pppd     
  [ ! -f /tmp/InterfaceStatus/CWAN1_1Status ] && touch /tmp/InterfaceStatus/CWAN1_1Status                                  
  echo "`date` Interface CWAN1_1 DOWN" >> /tmp/InterfaceStatus/CWAN1_1Status
  echo "0" > /tmp/networkstatus 
fi  

if ([ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "CWAN1_1" ]) || ([ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "wan6c2" ]); then            
   # Do something on an ifup event for the wan interface only 
   if [ "$IpsecEnable" = "1" ] ; then      
     interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2"  
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                 
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                                
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi  
  if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
   fi 
   if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi
      gtway=$(ifstatus CWAN1_1 | grep -i "nexthop" | cut -d "\"" -f 4) 
   if [ "$EthernetProtocolPort5wan2" = "pptp" ]
   then
      #/sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev usb0 metric "${cwan2metric}" > /dev/null 2>&1
	 ip route add "${EthernetClientPptpServerAddress}" via "${gtway}" dev usb0 proto static metric "${cwan2metric}"  > /dev/null 2>&1
   elif  [ "$EthernetProtocolPort5wan2" = "l2tp" ]
   then
    #/sbin/route del -net default gw "${EthernetClientStaticGatewayPort5wan2}" dev usb0 metric "${cwan2metric}" > /dev/null 2>&1
	ip route add "${EthernetClientPptpServerAddress}" via "${gtway}" dev usb0 proto static metric "${cwan2metric}"  > /dev/null 2>&1
   fi
     
   killall pppd    
  [ ! -f /tmp/InterfaceStatus/CWAN1_1Status ] && touch /tmp/InterfaceStatus/CWAN1_1Status                                        
  echo "`date` Interface CWAN1_1 UP" >> /tmp/InterfaceStatus/CWAN1_1Status
   echo "1" > /tmp/networkstatus 
     BordType=$(uci get boardconfig.board.moduletype)

	if [ "$BordType" = "2" ] || [ "$BordType" = "3" ] || [ "$BordType" = "6" ]
	then
	atnetworkinfo1=$(gcom -d /dev/"${PortType1}""${ComPort1}" -s /etc/gcom/atnetworkinfo1.gcom | awk 'NR==2')
	atnetworklatchinfo=$(echo "$atnetworkinfo1" | cut -d ":" -f 2 | cut -d "," -f 4 | tr -d '\011\012\013\014\015\040')

	if [ $atnetworklatchinfo -eq 7 ] || [ $atnetworklatchinfo -eq 8 ]
	then
	echo "$ProgramLed1OnValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	else
	echo "$ProgramLed1OffValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	fi

	fi                               
fi        

if ([ "${ACTION}" = "disconnected" ] && [ "${INTERFACE}" = "CWAN1" ]) || ([ "${ACTION}" = "disconnected" ] && [ "${INTERFACE}" = "wan6c1" ])  ; then 
     BordType=$(uci get boardconfig.board.moduletype)

	if [ "$BordType" = "2" ] || [ "$BordType" = "3" ] || [ "$BordType" = "6" ]
	then
	echo "$ProgramLed1OffValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	fi
  gtway=$(ifstatus CWAN1 | grep -i "nexthop" | cut -d "\"" -f 4)                                                               
 /sbin/route del -net default gw "${gtway}" dev 3g-CWAN1 metric "${cwan1metric}" > /dev/null 2>&1                                   
 /sbin/route del -net default gw "${gtway}" dev 3g-CWAN1 metric "${cwan1metric}0" > /dev/null 2>&1                                   
 sleep 2                                                                                                                         
 /sbin/route add -net default gw "${gtway}" dev 3g-CWAN1 metric "${cwan1metric}0" > /dev/null 2>&1
 	ip route add "${EthernetClientPptpServerAddress}" via "${gtway}" dev usb0 proto static metric "${cwan1metric}"  > /dev/null 2>&1
  
  source /tmp/InterfaceManager/status/ports.txt
   for i in 1 2 3
   do
	simid=$(/bin/at-cmd "$ComPort"  AT+qccid | awk FNR==2 | cut -d ":" -f 2) >> /tmp/InterfaceStatus/CWAN1Status 
	if [ "${#simid}" -gt 10 ]
	then
	   status="READY"
	   echo "$date:sim qccid is $simid" >> "$Logfile"
	   /root/usrRPC/script/Recycle_WAN1_PWR_Script.sh
	   break
	else
	   status="NOTREADY"
	   ifconfig usb0 down
	   ifconfig usb0 up
	   echo "$date:sim qccid is not ready $simid" >> "$Logfile"
	fi
   done
  
 if [ "$IpsecEnable" = "1" ] ; then 
    interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2" 
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                  
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                               
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi  
   killall pppd
 if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
 fi
 if [ "${NMS_Enable}" = "1" ]
 then
	/etc/init.d/openvpn restart
  fi      
  [ ! -f /tmp/InterfaceStatus/CWAN1Status ] && touch /tmp/InterfaceStatus/CWAN1Status                                        
  echo "`date` Interface CWAN1 DOWN" >> /tmp/InterfaceStatus/CWAN1Status 
  echo "0" > /tmp/networkstatus
fi

if ([ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "CWAN1" ]) || ([ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "wan6c1" ]) ; then                      
   # Do something on an ifup event for the wan interface only
 gtway=$(ifstatus CWAN1 | grep -i "nexthop" | cut -d "\"" -f 4)                                                                 
 /sbin/route del -net default gw "${gtway}" dev 3g-CWAN1 metric "${cwan1metric}" > /dev/null 2>&1                                
 /sbin/route del -net default gw "${gtway}" dev 3g-CWAN1 metric "${cwan1metric}0" > /dev/null 2>&1                               
 sleep 2                                                                                                                         
 /sbin/route add -net default gw "${gtway}" dev 3g-CWAN1 metric "${cwan1metric}" > /dev/null 2>&1  
 	ip route add "${EthernetClientPptpServerAddress}" via "${gtway}" dev usb0 proto static metric "${cwan1metric}"  > /dev/null 2>&1 
 if [ "$IpsecEnable" = "1" ] ; then                          
     interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2"
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                   
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                                
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi  
  if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
 fi
 killall pppd
    if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi      
  [ ! -f /tmp/InterfaceStatus/CWAN1Status ] && touch /tmp/InterfaceStatus/CWAN1Status                                        
  echo "`date` Interface CWAN1 UP" >> /tmp/InterfaceStatus/CWAN1Status 
   echo "1" > /tmp/networkstatus 
     BordType=$(uci get boardconfig.board.moduletype)

	if [ "$BordType" = "2" ] || [ "$BordType" = "3" ] || [ "$BordType" = "6" ]
	then
	atnetworkinfo1=$(gcom -d /dev/"${PortType1}""${ComPort1}" -s /etc/gcom/atnetworkinfo1.gcom | awk 'NR==2')
	atnetworklatchinfo=$(echo "$atnetworkinfo1" | cut -d ":" -f 2 | cut -d "," -f 4 | tr -d '\011\012\013\014\015\040')

	if [ $atnetworklatchinfo -eq 7 ] || [ $atnetworklatchinfo -eq 8 ]
	then
	echo "$ProgramLed1OnValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	else
	echo "$ProgramLed1OffValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	fi

	fi                                                      
fi 

if [ "${ACTION}" = "disconnected" ] && [ "${INTERFACE}" = "CWAN2" ] ; then
     BordType=$(uci get boardconfig.board.moduletype)

	if [ "$BordType" = "2" ] || [ "$BordType" = "3" ] || [ "$BordType" = "6" ]
	then
	echo "$ProgramLed1OffValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	fi
 gtway=$(ifstatus CWAN2 | grep -i "nexthop" | cut -d "\"" -f 4)                                                                 
 /sbin/route del -net default gw "${gtway}" dev 3g-CWAN2 metric "${cwan2metric}" > /dev/null 2>&1                                
 /sbin/route del -net default gw "${gtway}" dev 3g-CWAN2 metric "${cwan2metric}0" > /dev/null 2>&1                               
 sleep 2                                                                                                                         
 /sbin/route add -net default gw "${gtway}" dev 3g-CWAN2 metric "${cwan2metric}0" > /dev/null 2>&1 
  ip route add "${EthernetClientPptpServerAddress}" via "${gtway}" dev usb0 proto static metric "${cwan2metric}"  > /dev/null 2>&1 
  if [ "$IpsecEnable" = "1" ] ; then                
     interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2"
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                   
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                              
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi  
   killall pppd
if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
 fi
    if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi      
  [ ! -f /tmp/InterfaceStatus/CWAN2Status ] && touch /tmp/InterfaceStatus/CWAN2Status                                        
  echo "`date` Interface CWAN2 DOWN" >> /tmp/InterfaceStatus/CWAN2Status 
  echo "0" > /tmp/networkstatus                                                      
fi   

if [ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "CWAN2" ] ; then                      
   # Do something on an ifup event for the wan interface only
  gtway=$(ifstatus CWAN1 | grep -i "nexthop" | cut -d "\"" -f 4)                                                                 
 /sbin/route del -net default gw "${gtway}" dev 3g-CWAN1 metric "${cwan1metric}" > /dev/null 2>&1                                
 /sbin/route del -net default gw "${gtway}" dev 3g-CWAN1 metric "${cwan1metric}0" > /dev/null 2>&1                               
 sleep 2                                                                                                                         
 /sbin/route add -net default gw "${gtway}" dev 3g-CWAN1 metric "${cwan1metric}" > /dev/null 2>&1  
  	ip route add "${EthernetClientPptpServerAddress}" via "${gtway}" dev usb0 proto static metric "${cwan1metric}"  > /dev/null 2>&1  
  if [ "$IpsecEnable" = "1" ] ; then                          
    interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2" 
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                  
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                               
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi    
   killall pppd
  if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
 fi
    if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi      
  [ ! -f /tmp/InterfaceStatus/CWAN2Status ] && touch /tmp/InterfaceStatus/CWAN2Status                                            
  echo "`date` Interface CWAN2 UP" >> /tmp/InterfaceStatus/CWAN2Status 
   echo "1" > /tmp/networkstatus 
     BordType=$(uci get boardconfig.board.moduletype)

	if [ "$BordType" = "2" ] || [ "$BordType" = "3" ] || [ "$BordType" = "6" ]
	then
	atnetworkinfo1=$(gcom -d /dev/"${PortType1}""${ComPort1}" -s /etc/gcom/atnetworkinfo1.gcom | awk 'NR==2')
	atnetworklatchinfo=$(echo "$atnetworkinfo1" | cut -d ":" -f 2 | cut -d "," -f 4 | tr -d '\011\012\013\014\015\040')

	if [ $atnetworklatchinfo -eq 7 ] || [ $atnetworklatchinfo -eq 8 ]
	then
	echo "$ProgramLed1OnValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	else
	echo "$ProgramLed1OffValue" > /sys/class/gpio/gpio$ProgramLed1Number/value
	fi

	fi                                                       
fi 

if [ "${ACTION}" = "disconnected" ] && [ "${INTERFACE}" = "WIFI_WAN" ] ; then 
 gtway=$(ifstatus WIFI_WAN | grep -i "nexthop" | cut -d "\"" -f 4)
 /sbin/route del -net default gw "${gtway}" dev apcli0 metric "${wifimetric}" > /dev/null 2>&1
 /sbin/route del -net default gw "${gtway}" dev apcli0 metric "${wifimetric}"0 > /dev/null 2>&1
 sleep 2
 /sbin/route add -net default gw "${gtway}" dev apcli0 metric "${wifimetric}"0 > /dev/null 2>&1                
  if [ "$IpsecEnable" = "1" ] ; then                          
    interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2" 
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                  
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                               
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi    

 if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
 fi
 killall pppd
    if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi      
  [ ! -f /tmp/InterfaceStatus/WIFI_WANStatus ] && touch /tmp/InterfaceStatus/WIFI_WANStatus                                            
  echo "`date` Interface WIFI_WAN DOWN" >> /tmp/InterfaceStatus/WIFI_WANStatus                                                        
fi

if [ "${ACTION}" = "ifup" ] && [ "${INTERFACE}" = "WIFI_WAN" ] ; then                      
   # Do something on an ifup event for the wan interface only
    gtway=$(ifstatus WIFI_WAN | grep -i "nexthop" | cut -d "\"" -f 4)                                                               
   /sbin/route del -net default gw "${gtway}" dev apcli0 metric "${wifimetric}"0 > /dev/null 2>&1
   /sbin/route del -net default gw "${gtway}" dev apcli0 metric "${wifimetric}" > /dev/null 2>&1                                 
   sleep 2                                                                                                                         
   /sbin/route add -net default gw "${gtway}" dev apcli0 metric "${wifimetric}" > /dev/null 2>&1                             
  if [ "$IpsecEnable" = "1" ] ; then                          
    interfac=$(route -n | awk NR==3 | awk '{print $8}')                                                                           
   if [ "$interfac" = "eth0.4" ]                                                                                                 
   then                                                                                                                          
     uci set ipsec.general.interface="EWAN1"                                                                                     
     uci set firewall.ipsec_rule1.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN1"                                                                                     
   elif [ "$interfac" = "eth0.5" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="EWAN2" 
     uci set firewall.ipsec_rule1.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="EWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="EWAN2" 
   elif [ "$interfac" = "apcli0" ]                                                                                               
   then                                                                                                                          
      uci set ipsec.general.interface="WIFI_WAN" 
     uci set firewall.ipsec_rule1.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule2.src="WIFI_WAN"                                                                                     
     uci set firewall.ipsec_rule3.src="WIFI_WAN"                                                                                  
   elif [ "$interfac" = "3g-CWAN1" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1"
     uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1"                                                                                    
   elif [ "$interfac" = "3g-CWAN2" ]                                                                                             
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN2"  
     uci set firewall.ipsec_rule1.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN2"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN2"                                                                                    
   elif [ "$interfac" = "3g-CWAN1_0" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_0"  
     uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                                  
   elif [ "$interfac" = "3g-CWAN1_1" ]                                                                                           
   then                                                                                                                          
      uci set ipsec.general.interface="CWAN1_1" 
     uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
     uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                                   
   elif [ "$interfac" = "usb0" ]                                                                                                 
   then                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1" 
            uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                               
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0"
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                            
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                                                                                                    
       fi                                                                                                                        
   else                                                                                                                          
       if [ "$CellularOperationModelocal" = "singlecellularsinglesim" ]                                                          
       then                                                                                                                      
           uci set ipsec.general.interface="CWAN1"
           uci set firewall.ipsec_rule1.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule2.src="CWAN1"                                                                                     
           uci set firewall.ipsec_rule3.src="CWAN1"                                                                                
       else                                                                                                                      
           simnum=$(cat /tmp/simnumfile)                                                                                         
           if [ "$simnum" = "1" ]                                                                                                
           then                                                                                                                  
             uci set ipsec.general.interface="CWAN1_0" 
             uci set firewall.ipsec_rule1.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_0"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_0"                                                                           
           else                                                                                                                  
             uci set ipsec.general.interface="CWAN1_1"
             uci set firewall.ipsec_rule1.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule2.src="CWAN1_1"                                                                                     
             uci set firewall.ipsec_rule3.src="CWAN1_1"                                                                            
           fi                                      
         fi                                                                                                                        
    fi                                                                                                                           
    uci commit ipsec
    uci commit firewall
    sleep 1
    /etc/init.d/firewall reload
                                                                                               
   /etc/init.d/ipsec stop                                                                                                        
   /bin/sleep 1                                                                                                                  
   /etc/init.d/ipsec start                                                                                                       
   /bin/sleep 4                                                                                                                  
   /usr/sbin/ipsec restart                                                                                                       
   fi   
   killall pppd 

  if [ "$OpenvpnEnable" = "1" ] ; then                             
   /etc/init.d/openvpn restart                                      
 fi
    if [ "${NMS_Enable}" = "1" ]
   then
	/etc/init.d/openvpn restart
   fi      
  [ ! -f /tmp/InterfaceStatus/WIFI_WANStatus ] && touch /tmp/InterfaceStatus/WIFI_WANStatus                                              
  echo "`date` Interface WIFI_WAN UP" >> /tmp/InterfaceStatus/WIFI_WANStatus 
   echo "1" > /tmp/networkstatus                                                      
fi 

